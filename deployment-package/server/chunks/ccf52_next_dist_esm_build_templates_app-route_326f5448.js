module.exports=[84572,e=>{"use strict";e.s(["handler",()=>B,"patchFetch",()=>D,"routeModule",()=>M,"serverHooks",()=>H,"workAsyncStorage",()=>F,"workUnitAsyncStorage",()=>U],84572);var t=e.i(12572),a=e.i(8616),r=e.i(89541),o=e.i(32989),n=e.i(52314),s=e.i(28507),i=e.i(18687),c=e.i(5098),l=e.i(21777),d=e.i(68439),u=e.i(65518),p=e.i(78823),h=e.i(79205),w=e.i(26104),g=e.i(93695);e.i(22291);var f=e.i(13079);e.s(["GET",()=>N,"POST",()=>_],51675);var m=e.i(606),y=e.i(37635);let v=new class{apiUrl;accessToken;constructor(e=process.env.WHATSAPP_API_URL,t=process.env.WHATSAPP_API_TOKEN){this.apiUrl=e,this.accessToken=t}async sendMessage(e,t){try{let e=await fetch(`${this.apiUrl}/v1/messages`,{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json","D360-API-KEY":this.accessToken},body:JSON.stringify({messaging_product:"whatsapp",...t})});if(!e.ok)throw Error(`WhatsApp API Error: ${e.status} ${e.statusText}`);return await e.json()}catch(e){throw console.error("Failed to send WhatsApp message:",e),e}}async sendTextMessage(e,t,a){return this.sendMessage(e,{to:t,type:"text",text:{body:a}})}async sendTemplateMessage(e,t,a,r="de",o){return this.sendMessage(e,{to:t,type:"template",template:{name:a,language:{code:r},components:o}})}async downloadMedia(e){try{let t=await fetch(`${this.apiUrl}/v1/media/${e}`,{headers:{Authorization:`Bearer ${this.accessToken}`,"D360-API-KEY":this.accessToken}});if(!t.ok)throw Error(`Failed to get media URL: ${t.status}`);let{url:a}=await t.json(),r=await fetch(a,{headers:{Authorization:`Bearer ${this.accessToken}`,"D360-API-KEY":this.accessToken}});if(!r.ok)throw Error(`Failed to download media: ${r.status}`);return Buffer.from(await r.arrayBuffer())}catch(e){throw console.error("Failed to download WhatsApp media:",e),e}}async uploadMedia(e,t,a,r){try{let e=new FormData;e.append("messaging_product","whatsapp"),e.append("file",new Blob([new Uint8Array(t)],{type:a}),r||"file"),e.append("type",a);let o=await fetch(`${this.apiUrl}/v1/media`,{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,"D360-API-KEY":this.accessToken},body:e});if(!o.ok)throw Error(`Failed to upload media: ${o.status}`);let{id:n}=await o.json();return n}catch(e){throw console.error("Failed to upload WhatsApp media:",e),e}}async markAsRead(e,t){try{return(await fetch(`${this.apiUrl}/v1/messages`,{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json","D360-API-KEY":this.accessToken},body:JSON.stringify({messaging_product:"whatsapp",status:"read",message_id:t})})).ok}catch(e){return console.error("Failed to mark message as read:",e),!1}}};async function A(e,t,a){try{let t={bot:e,contactPhone:a.contactPhone||"",lastMessage:a,variables:{}},r=await b(t);if(t.currentFlow=r.currentFlow||void 0,t.currentNode=r.currentNode||void 0,t.variables=r.variables,t.currentFlow||(t.currentFlow=await R(t,a.content)||void 0),!t.currentFlow)return void await k(t);await E(t)}catch(t){console.error("âŒ Error processing message:",t),await x(e,a.contactPhone)}}async function b(e){return await y.prisma.message.findFirst({where:{botId:e.bot.id,contactPhone:e.contactPhone,direction:"outgoing",createdAt:{gte:new Date(Date.now()-18e5)}},orderBy:{createdAt:"desc"}}),{currentFlow:null,currentNode:null,variables:{}}}async function R(e,t){let{flows:a}=e.bot;for(let e of a)if("keyword"===e.triggerType&&e.triggerValue){let a=e.triggerValue.toLowerCase().split(",").map(e=>e.trim()),r=t.toLowerCase().split(/\s+/);for(let t of a)if(r.includes(t))return e}let r=a.find(e=>"always"===e.triggerType);return r||null}async function E(e){if(e.currentFlow)try{let{nodes:t,edges:a}=e.currentFlow.nodes,r=e.currentNode?t.find(t=>t.id===e.currentNode):t.find(e=>"start"===e.type);if(!r)return void console.error("âŒ No start node found in flow");let o=10;for(;r&&o>0&&(o--,!(await T(e,r)).stop);){let e=a.find(e=>e.source===r.id);if(!e)break;r=t.find(t=>t.id===e.target)}}catch(e){throw console.error("âŒ Error executing flow:",e),e}}async function T(e,t){switch(t.type){case"start":case"condition":case"api_call":case"delay":return{};case"message":return await P(e,t.data.text||t.data.message),{};case"collect_input":return await P(e,t.data.prompt||"Bitte antworten Sie:"),{stop:!0};case"end":return{stop:!0};default:return console.warn(`âš ï¸  Unknown node type: ${t.type}`),{}}}async function P(e,t){try{var a,r;if(!e.bot.whatsappPhoneId||!e.bot.whatsappToken)return void console.error("âŒ Bot not configured for WhatsApp");let o=(a=t,r=e.variables,a.replace(/\{\{(\w+)\}\}/g,(e,t)=>r[t]||e));await v.sendTextMessage(e.bot.whatsappPhoneId,e.contactPhone,o),await y.prisma.message.create({data:{direction:"outgoing",content:o,contactPhone:e.contactPhone,botId:e.bot.id}}),console.log(`ðŸ“¤ Sent: ${o.substring(0,50)}...`)}catch(e){throw console.error("âŒ Error sending message:",e),e}}async function k(e){let t=e.bot.fallbackMessage||"Entschuldigung, ich habe das nicht verstanden. KÃ¶nnen Sie das anders formulieren?";await P(e,t)}async function x(e,t){try{if(!e.whatsappPhoneId)return;let a="Es tut mir leid, es ist ein technischer Fehler aufgetreten. Bitte versuchen Sie es spÃ¤ter erneut.";await v.sendTextMessage(e.whatsappPhoneId,t,a),await y.prisma.message.create({data:{direction:"outgoing",content:a,contactPhone:t,botId:e.id}})}catch(e){console.error("âŒ Error sending error message:",e)}}async function N(e){let{searchParams:t}=new URL(e.url),a=t.get("hub.mode"),r=t.get("hub.verify_token"),o=t.get("hub.challenge");return"subscribe"===a&&r===process.env.WHATSAPP_WEBHOOK_VERIFY_TOKEN?(console.log("âœ… WhatsApp webhook verified"),new m.NextResponse(o,{status:200})):(console.log("âŒ WhatsApp webhook verification failed"),new m.NextResponse("Verification failed",{status:403}))}async function _(t){try{let a=await t.text(),r=t.headers.get("x-hub-signature-256")||"";if(!function(t,a,r=process.env.WHATSAPP_WEBHOOK_SECRET){try{let o=e.r(54799).createHmac("sha256",r).update(t).digest("hex");return a===`sha256=${o}`}catch(e){return console.error("Failed to validate webhook signature:",e),!1}}(a,r))return console.error("âŒ Invalid webhook signature"),new m.NextResponse("Invalid signature",{status:401});let o=JSON.parse(a);return await C(o),new m.NextResponse("OK",{status:200})}catch(e){return console.error("âŒ Webhook processing error:",e),new m.NextResponse("Internal Server Error",{status:500})}}async function C(e){if(!e.entry||!Array.isArray(e.entry))return void console.log("âš ï¸  No entries in webhook data");for(let t of e.entry)if(t.changes&&Array.isArray(t.changes))for(let e of t.changes){if("messages"!==e.field)continue;let{value:t}=e;if(t.messages&&Array.isArray(t.messages))for(let e of t.messages)await $(e,t.metadata);if(t.statuses&&Array.isArray(t.statuses))for(let e of t.statuses)await I(e)}}async function $(e,t){try{let a=t.phone_number_id,r=e.from.replace(/^\+/,"").replace(/\D/g,"");console.log(`ðŸ“¨ Incoming message from ${r}:`,e.type);let o=await y.prisma.bot.findFirst({where:{whatsappPhoneId:a,isActive:!0},include:{flows:{where:{isActive:!0},orderBy:{position:"asc"}}}});if(!o)return void console.log(`âš ï¸  No active bot found for phone number ${a}`);let n=await y.prisma.message.create({data:{direction:"incoming",content:function(e){switch(e.type){case"text":return e.text?.body||"";case"image":return e.image?.caption||"[Bild]";case"document":return e.document?.caption||`[Dokument: ${e.document?.filename}]`;case"audio":return"[Sprachnachricht]";case"video":return e.video?.caption||"[Video]";case"location":return`[Standort: ${e.location?.latitude}, ${e.location?.longitude}]`;case"contacts":return"[Kontakt geteilt]";case"interactive":if(e.interactive?.type==="button_reply")return e.interactive.button_reply.title;if(e.interactive?.type==="list_reply")return e.interactive.list_reply.title;return"[Interaktive Nachricht]";default:return`[${e.type}]`}}(e),mediaUrl:await S(e),mediaType:"text"!==e.type?e.type:null,contactPhone:r,contactName:e.profile?.name||null,whatsappMessageId:e.id,botId:o.id}});await A(o,e,n),console.log(`âœ… Message processed for bot ${o.name}`)}catch(e){console.error("âŒ Error handling incoming message:",e)}}async function I(e){try{let t=e.id,a=e.status;await y.prisma.message.updateMany({where:{whatsappMessageId:t},data:{whatsappStatus:a}}),console.log(`ðŸ“Š Message ${t} status updated to: ${a}`)}catch(e){console.error("âŒ Error updating message status:",e)}}async function S(e){try{if("image"===e.type&&e.image?.id)return`/api/media/whatsapp/${e.image.id}`;if("document"===e.type&&e.document?.id)return`/api/media/whatsapp/${e.document.id}`;if("audio"===e.type&&e.audio?.id)return`/api/media/whatsapp/${e.audio.id}`;if("video"===e.type&&e.video?.id)return`/api/media/whatsapp/${e.video.id}`;return null}catch(e){return console.error("âŒ Error getting media URL:",e),null}}var O=e.i(51675);let M=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/webhooks/whatsapp/route",pathname:"/api/webhooks/whatsapp",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/botchat-pro/app/api/webhooks/whatsapp/route.ts",nextConfigOutput:"",userland:O}),{workAsyncStorage:F,workUnitAsyncStorage:U,serverHooks:H}=M;function D(){return(0,r.patchFetch)({workAsyncStorage:F,workUnitAsyncStorage:U})}async function B(e,t,r){var m;let y="/api/webhooks/whatsapp/route";y=y.replace(/\/index$/,"")||"/";let v=await M.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:A,params:b,nextConfig:R,isDraftMode:E,prerenderManifest:T,routerServerContext:P,isOnDemandRevalidate:k,revalidateOnlyGenerated:x,resolvedPathname:N}=v,_=(0,s.normalizeAppPath)(y),C=!!(T.dynamicRoutes[_]||T.routes[N]);if(C&&!E){let e=!!T.routes[N],t=T.dynamicRoutes[_];if(t&&!1===t.fallback&&!e)throw new g.NoFallbackError}let $=null;!C||M.isDev||E||($="/index"===($=N)?"/":$);let I=!0===M.isDev||!C,S=C&&!I,O=e.method||"GET",F=(0,n.getTracer)(),U=F.getActiveScopeSpan(),H={params:b,prerenderManifest:T,renderOpts:{experimental:{cacheComponents:!!R.experimental.cacheComponents,authInterrupts:!!R.experimental.authInterrupts},supportsDynamicResponse:I,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:null==(m=R.experimental)?void 0:m.cacheLife,isRevalidate:S,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>M.onRequestError(e,t,r,P)},sharedContext:{buildId:A}},D=new i.NodeNextRequest(e),B=new i.NodeNextResponse(t),K=c.NextRequestAdapter.fromNodeNextRequest(D,(0,c.signalFromNodeResponse)(t));try{let s=async a=>M.handle(K,H).finally(()=>{if(!a)return;a.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=r.get("next.route");if(o){let e=`${O} ${o}`;a.setAttributes({"next.route":o,"http.route":o,"next.span_name":e}),a.updateName(e)}else a.updateName(`${O} ${e.url}`)}),i=async n=>{var i,c;let l=async({previousCacheEntry:a})=>{try{if(!(0,o.getRequestMeta)(e,"minimalMode")&&k&&x&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(n);e.fetchMetrics=H.renderOpts.fetchMetrics;let c=H.renderOpts.pendingWaitUntil;c&&r.waitUntil&&(r.waitUntil(c),c=void 0);let l=H.renderOpts.collectedTags;if(!C)return await (0,u.sendResponse)(D,B,i,H.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(i.headers);l&&(t[w.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,r=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await M.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isRevalidate:S,isOnDemandRevalidate:k})},P),t}},g=await M.handleResponse({req:e,nextConfig:R,cacheKey:$,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:k,revalidateOnlyGenerated:x,responseGenerator:l,waitUntil:r.waitUntil});if(!C)return null;if((null==g||null==(i=g.value)?void 0:i.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==g||null==(c=g.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,o.getRequestMeta)(e,"minimalMode")||t.setHeader("x-nextjs-cache",k?"REVALIDATED":g.isMiss?"MISS":g.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(g.value.headers);return(0,o.getRequestMeta)(e,"minimalMode")&&C||m.delete(w.NEXT_CACHE_TAGS_HEADER),!g.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,h.getCacheControlHeader)(g.cacheControl)),await (0,u.sendResponse)(D,B,new Response(g.value.body,{headers:m,status:g.value.status||200})),null};U?await i(U):await F.withPropagatedContext(e.headers,()=>F.trace(l.BaseServerSpan.handleRequest,{spanName:`${O} ${e.url}`,kind:n.SpanKind.SERVER,attributes:{"http.method":O,"http.target":e.url}},i))}catch(t){if(U||t instanceof g.NoFallbackError||await M.onRequestError(e,t,{routerKind:"App Router",routePath:_,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isRevalidate:S,isOnDemandRevalidate:k})}),C)throw t;return await (0,u.sendResponse)(D,B,new Response(null,{status:500})),null}}}];

//# sourceMappingURL=ccf52_next_dist_esm_build_templates_app-route_326f5448.js.map